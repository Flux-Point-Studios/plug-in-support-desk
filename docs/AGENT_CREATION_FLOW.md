# Agent Creation Flow

This document explains the complete flow for creating and registering AI agents in the system.

## Overview

The agent creation process involves:
1. User describes their business and agent requirements
2. AI generates agent configuration suggestions
3. User uploads documentation
4. System creates agent container (future implementation)
5. Agent is registered with Masumi network
6. Agent becomes available for use

## Detailed Flow

### 1. User Interface (Dashboard)

User fills out the agent creation form:
- **Business Description**: Describes their business and support needs
- **Agent Name**: Generated by AI or manually entered
- **Agent Bio**: Short description of the agent's expertise
- **Detailed Description**: Comprehensive agent personality and knowledge areas
- **Documentation**: Upload PDFs, docs, or markdown files

### 2. AI Configuration Generation

When user clicks "Generate Agent Configuration":

```typescript
// src/lib/ai-service.ts
generateAgentConfig({
  businessPrompt: "User's business description"
}) → {
  name: "Suggested agent name",
  bio: "Suggested bio",
  description: "Suggested detailed description"
}
```

The Flux Point Studios AI service analyzes the business description and generates appropriate suggestions.

### 3. Document Upload

Files are uploaded to Supabase Storage:
- Stored in `agent-docs` bucket
- Organized by user ID: `{userId}/{timestamp}_{random}.{ext}`
- Public URLs generated for agent access

### 4. Agent Creation

When user clicks "Create AI Agent":

```typescript
// src/lib/agents.ts
createAgent({
  name: "Agent name",
  description: "Description",
  bio: "Bio",
  documents: File[]
}) → {
  id: "agent-uuid",
  masumiIdentifier: "masumi-id",
  status: "registered"
}
```

This process:
1. Creates agent record in Supabase
2. Uploads documents to storage
3. Registers with Masumi network
4. Polls for registration completion

### 5. Masumi Registration

The agent is registered on the Masumi network:

```typescript
// src/lib/masumi.ts
registerAgent({
  name: "Agent name",
  description: "Description",
  apiUrl: "https://api.example.com/agents/{id}",
  pricing: { unit: "usdm", quantity: "50000000" }, // 0.05 USDM
  tags: ["support", "ai", "helpdesk"]
})
```

Registration payload includes:
- Agent metadata (name, description)
- API endpoint URL
- Pricing information
- Capability declaration
- Legal links

### 6. Status Monitoring

After registration, the system polls for completion:

```typescript
waitForRegistration(agentIdentifier, maxAttempts: 20, delayMs: 3000)
```

States:
- `RegistrationRequested`: Initial state
- `Registered`: Successfully registered on-chain
- `Failed`/`Rejected`: Registration failed

## Database Schema

### Agents Table

```sql
CREATE TABLE agents (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES auth.users,
  name TEXT,
  description TEXT,
  bio TEXT,
  masumi_id TEXT UNIQUE,
  api_url TEXT,
  status TEXT, -- 'pending', 'registered', 'failed'
  doc_urls TEXT[],
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

## Environment Requirements

```env
# AI Service
VITE_AGENT_API_URL=https://api.fluxpointstudios.com/chat
VITE_AGENT_API_KEY=your_api_key

# Masumi Network
VITE_MASUMI_PAYMENT_URL=http://localhost:3001
VITE_MASUMI_API_KEY=your_pay_scoped_key
VITE_MASUMI_VKEY=selling_wallet_vkey
VITE_MASUMI_NETWORK=Preprod
```

## Error Handling

Common errors and solutions:

| Error | Cause | Solution |
|-------|-------|----------|
| "MASUMI_API_KEY not set" | Missing env variable | Add to .env file |
| "Invalid API Key" | Wrong Flux Point API key | Check key format |
| "Registration failed" | Masumi network issue | Check wallet balance, retry |
| "Upload failed" | Storage bucket issue | Check Supabase config |

## Future Enhancements

1. **Container Deployment**: Automatically deploy agent containers
2. **Custom Training**: Fine-tune agents with uploaded documents
3. **Analytics**: Track agent performance and usage
4. **Multi-agent Support**: Create specialized agent teams
5. **Version Control**: Track agent configuration changes

## Testing

To test the flow:
1. Set up all services (Supabase, Masumi, Flux Point)
2. Connect wallet with admin address for free access
3. Create test agent with sample documents
4. Verify registration in Masumi registry
5. Test agent in support portal 